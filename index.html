<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BillCheck – Quick Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      /* Light theme (default) */
      --bg: #f3f4f6;
      --bg-elevated: #ffffff;
      --bg-elevated-soft: #f9fafb;
      --bg-video: #000000;
      --border-soft: rgba(148, 163, 184, 0.4);
      --border-subtle: rgba(148, 163, 184, 0.25);
      --text: #111827;
      --text-muted: #6b7280;
      --text-softer: #9ca3af;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --badge: #0284c7;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.18);
    }

    body.theme-dark {
      --bg: #0f172a;
      --bg-elevated: #020617;
      --bg-elevated-soft: #111827;
      --bg-video: #000000;
      --border-soft: rgba(148, 163, 184, 0.4);
      --border-subtle: rgba(148, 163, 184, 0.2);
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --text-softer: #9ca3af;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.18);
      --badge: #38bdf8;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.45);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 0;
    }

    .app {
      width: 100%;
      max-width: 480px;
      background: var(--bg-elevated);
      border-radius: 1rem;
      padding: 1rem 1.25rem 1.5rem;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: auto;
      transition: background 0.2s ease, color 0.2s ease, border-radius 0.2s ease, box-shadow 0.2s ease;
    }

    /* Fullscreen capture mode */
    .app.scanning-full {
      max-width: none;
      width: 100%;
      height: 100vh;
      border-radius: 0;
      padding: 0;
      box-shadow: none;
      background: #000;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .badge {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--badge);
    }

    header h1 {
      font-size: 1.2rem;
      font-weight: 700;
    }

    header p {
      font-size: 0.8rem;
      color: var(--text-softer);
      line-height: 1.4;
    }

    .lang-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      overflow: hidden;
      font-size: 0.7rem;
      background: var(--bg-elevated-soft);
    }

    .lang-btn {
      border: none;
      background: transparent;
      color: var(--text-softer);
      padding: 0.25rem 0.55rem;
      cursor: pointer;
      font-weight: 500;
    }

    .lang-btn.active {
      background: var(--bg);
      color: var(--text);
    }

    .section {
      border-radius: 0.85rem;
      background: var(--bg-elevated-soft);
      border: 1px solid var(--border-subtle);
      padding: 0.75rem 0.85rem;
    }

    .section h2 {
      font-size: 0.95rem;
      margin-bottom: 0.4rem;
    }

    .section p {
      font-size: 0.8rem;
      color: var(--text-softer);
      line-height: 1.4;
    }

    .btn-row {
      margin-top: 0.75rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.55rem 1rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--accent);
      color: #022c22;
      transition: transform 0.08s ease, box-shadow 0.1s ease, background 0.12s ease;
      box-shadow: 0 7px 18px var(--accent-soft);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
    }

    button.secondary {
      background: var(--bg);
      color: var(--text);
      box-shadow: 0 0 0 rgba(0,0,0,0);
      border: 1px solid var(--border-soft);
    }

    button.subtle {
      background: var(--bg-elevated-soft);
      color: var(--text-muted);
      box-shadow: none;
      padding: 0.4rem 0.85rem;
      font-size: 0.78rem;
    }

    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .denom-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.4rem;
    }

    .denom-btn {
      font-size: 0.75rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: var(--bg-elevated);
      color: var(--text);
      cursor: pointer;
    }

    .denom-btn.active {
      background: var(--accent);
      color: #022c22;
      border-color: var(--accent);
    }

    .tiny {
      font-size: 0.7rem;
      color: var(--text-muted);
      line-height: 1.3;
    }

    /* Section visibility */
    #homeSection,
    #settingsSection,
    #scannerSection,
    #checklistSection,
    #resultsSection,
    #myScansSection {
      display: none;
    }

    #homeSection.active,
    #settingsSection.active,
    #scannerSection.active,
    #checklistSection.active,
    #resultsSection.active,
    #myScansSection.active {
      display: block;
    }

    /* Scanner */
    .scanner {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      position: relative;
    }

    .video-wrapper {
      position: relative;
      border-radius: 0.75rem;
      overflow: hidden;
      border: 1px solid var(--border-soft);
      background: var(--bg-video);
      flex: 1;
    }

    video, canvas {
      width: 100%;
      height: 100%;
      display: block;
      background: #000;
      object-fit: contain;
    }

    .frame-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .frame-box {
      width: 92%;
      aspect-ratio: 7 / 3;
      border: 2px dashed rgba(248, 250, 252, 0.8);
      border-radius: 0.6rem;
      box-shadow: 0 0 0 999px rgba(0, 0, 0, 0.35) inset;
    }

    .status-text {
      font-size: 0.75rem;
      color: var(--text-softer);
      margin-top: 0.25rem;
    }

    .current-denom {
      font-size: 0.75rem;
      color: #4f46e5;
      margin-top: 0.25rem;
    }

    .capture-row {
      justify-content: center;
      align-items: center;
    }

    .round-capture {
      width: 4rem;
      height: 4rem;
      border-radius: 999px;
      padding: 0;
      font-size: 0.8rem;
      box-shadow: 0 0 0 4px var(--accent-soft);
      background: radial-gradient(circle at 30% 30%, #bbf7d0, var(--accent));
    }

    .capture-row button.secondary {
      margin-left: 0.4rem;
    }

    /* Back button in scanner */
    #scannerBackBtn {
      position: absolute;
      top: 0.6rem;
      left: 0.6rem;
      z-index: 10;
      padding: 0.25rem 0.65rem;
      font-size: 0.8rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.7);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
    }

    /* Checklist / results */
    .checklist {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .step-indicator {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .step-header {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.25rem;
    }

    .step-body {
      font-size: 0.8rem;
      color: var(--text-softer);
      line-height: 1.4;
      margin-bottom: 0.4rem;
    }

    .answer-btn {
      flex: 1;
      min-width: 0;
    }

    .answer-btn.yes {
      background: #22c55e;
      color: #022c22;
    }

    .answer-btn.no {
      background: #ef4444;
      color: #fee2e2;
    }

    .answer-btn.maybe {
      background: #eab308;
      color: #422006;
    }

    .results {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .result-tag {
      font-size: 0.8rem;
      font-weight: 700;
      padding: 0.3rem 0.65rem;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .result-tag.ok {
      background: rgba(22, 163, 74, 0.2);
      color: #166534;
      border: 1px solid rgba(22, 163, 74, 0.6);
    }

    .result-tag.warn {
      background: rgba(234, 179, 8, 0.15);
      color: #854d0e;
      border: 1px solid rgba(234, 179, 8, 0.7);
    }

    .result-tag.bad {
      background: rgba(239, 68, 68, 0.18);
      color: #b91c1c;
      border: 1px solid rgba(239, 68, 68, 0.7);
    }

    .result-note {
      font-size: 0.8rem;
      color: var(--text-softer);
      line-height: 1.4;
    }

    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, var(--border-soft), transparent);
      margin: 0.25rem 0;
    }

    /* Settings layout */
    .settings-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.45rem;
      padding-top: 0.35rem;
      border-top: 1px solid var(--border-subtle);
    }

    .settings-row label {
      font-size: 0.8rem;
      color: var(--text);
    }

    .toggle-pill {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      overflow: hidden;
      background: var(--bg);
      font-size: 0.75rem;
    }

    .toggle-pill button {
      border-radius: 0;
      box-shadow: none;
      padding: 0.3rem 0.7rem;
      background: transparent;
      color: var(--text-softer);
      border: none;
    }

    .toggle-pill button.active {
      background: var(--accent-soft);
      color: #065f46;
    }

    /* Fullscreen scanning-only view rules */
    .app.scanning-full header,
    .app.scanning-full #homeSection,
    .app.scanning-full #settingsSection,
    .app.scanning-full #checklistSection,
    .app.scanning-full #resultsSection,
    .app.scanning-full #myScansSection {
      display: none !important;
    }

    .app.scanning-full #scannerSection {
      display: block !important;
      border-radius: 0;
      border: none;
      padding: 0;
      background: #000;
      height: 100%;
    }

    .app.scanning-full #scannerSection .scanner-inner {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .app.scanning-full #scannerTitle,
    .app.scanning-full #scannerBody,
    .app.scanning-full #currentDenomText,
    .app.scanning-full .status-text,
    .app.scanning-full #retakeBtn,
    .app.scanning-full #beginChecksBtn,
    .app.scanning-full .tiny {
      display: none !important;
    }

    .app.scanning-full .video-wrapper {
      flex: 1;
      border-radius: 0;
      border: none;
    }

    .app.scanning-full video,
    .app.scanning-full canvas {
      object-fit: contain;
      width: 100%;
      height: 100%;
    }

    .app.scanning-full .frame-box {
      border-color: rgba(248, 250, 252, 0.9);
    }

    .app.scanning-full .capture-row {
      padding: 0.5rem 0 0.75rem;
    }

    /* AI feature breakdown card */
    .results-features {
      margin-top: 0.35rem;
      padding: 0.55rem 0.6rem;
      border-radius: 0.65rem;
      background: var(--bg-elevated-soft);
      border: 1px solid var(--border-subtle);
    }

    .results-features-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.35rem;
    }

    .results-features-title {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text);
    }

    .results-features-sub {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .results-features-list {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .feature-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.75rem;
    }

    .feature-label {
      color: var(--text-softer);
      flex: 1;
    }

    .feature-right {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .feature-score {
      font-variant-numeric: tabular-nums;
      color: var(--text-muted);
    }

    .feature-status-pill {
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .feature-status-pill.ok {
      background: rgba(22, 163, 74, 0.16);
      color: #166534;
    }

    .feature-status-pill.warn {
      background: rgba(234, 179, 8, 0.16);
      color: #854d0e;
    }

    .feature-status-pill.fail {
      background: rgba(239, 68, 68, 0.18);
      color: #b91c1c;
    }

    /* My Scans */
    .my-scans-summary {
      font-size: 0.78rem;
      color: var(--text-softer);
      margin-bottom: 0.4rem;
    }

    .scan-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 260px;
      overflow-y: auto;
      margin-top: 0.2rem;
    }

    .scan-card {
      display: flex;
      gap: 0.55rem;
      padding: 0.4rem;
      border-radius: 0.65rem;
      background: var(--bg);
      border: 1px solid var(--border-subtle);
    }

    .scan-thumb {
      flex: 0 0 68px;
      height: 44px;
      border-radius: 0.35rem;
      overflow: hidden;
      background: #000;
      border: 1px solid rgba(15, 23, 42, 0.45);
    }

    .scan-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .scan-meta {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .scan-line-primary {
      font-size: 0.78rem;
      color: var(--text);
      display: flex;
      justify-content: space-between;
      gap: 0.3rem;
    }

    .scan-line-secondary {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.1rem;
    }

    .scan-tag {
      font-size: 0.7rem;
      padding: 0.05rem 0.45rem;
      border-radius: 999px;
      border: 1px solid transparent;
    }

    .scan-tag.ok {
      border-color: rgba(22, 163, 74, 0.7);
      color: #166534;
      background: rgba(22, 163, 74, 0.15);
    }

    .scan-tag.warn {
      border-color: rgba(234, 179, 8, 0.7);
      color: #854d0e;
      background: rgba(234, 179, 8, 0.15);
    }

    .scan-tag.bad {
      border-color: rgba(239, 68, 68, 0.7);
      color: #b91c1c;
      background: rgba(239, 68, 68, 0.16);
    }
  </style>
</head>
<body class="theme-light">
  <div class="app">
    <header>
      <div class="header-row">
        <div>
          <div class="badge" id="badgeText">Experimental tool</div>
          <h1 id="appTitle">BillCheck – Quick Screen</h1>
        </div>
        <div class="lang-toggle" aria-label="Language">
          <button class="lang-btn active" data-lang="en" id="langEn">EN</button>
          <button class="lang-btn" data-lang="es" id="langEs">ES</button>
        </div>
      </div>
      <p id="disclaimerText">
        This is a <strong>preliminary helper only</strong>. It cannot guarantee authenticity.
        When in doubt, have a bank or law enforcement verify the bill.
      </p>
    </header>

    <!-- HOME -->
    <section class="section" id="homeSection">
      <h2 id="howWorksTitle">How this works</h2>
      <p id="howWorksBody">
        Choose a U.S. bill, then we’ll use your camera to capture it, highlight key areas,
        and walk you through a quick AI-assisted screen.
      </p>

      <p class="tiny" id="denomLabel">
        Supported today: U.S. bills
      </p>
      <div class="denom-row" id="denomRow">
        <button class="denom-btn" data-denom="1">$1</button>
        <button class="denom-btn" data-denom="5">$5</button>
        <button class="denom-btn" data-denom="10">$10</button>
        <button class="denom-btn active" data-denom="20">$20</button>
        <button class="denom-btn" data-denom="50">$50</button>
        <button class="denom-btn" data-denom="100">$100</button>
      </div>
      <p class="tiny" id="intlComingSoon">
        International currencies: support coming soon.
      </p>

      <div class="btn-row">
        <button id="startScanBtn">Start scan</button>
        <button id="openMyScansBtn" class="secondary">My scans</button>
        <button id="openSettingsBtn" class="secondary">Settings</button>
      </div>
    </section>

    <!-- MY SCANS -->
    <section class="section" id="myScansSection">
      <h2 id="myScansTitle">My scans</h2>
      <p class="my-scans-summary" id="myScansSummary">
        No scans yet. When you run checks, your recent scans will show up here with a small thumbnail and risk summary.
      </p>

      <div class="scan-list" id="scanList"></div>

      <div class="btn-row" style="margin-top:0.6rem;">
        <button id="backFromMyScansBtn" class="secondary">Back to home</button>
        <button id="clearScansBtn" class="subtle">Clear all</button>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="section" id="settingsSection">
      <h2 id="settingsTitle">Settings</h2>
      <p id="settingsIntro">
        Adjust language and theme. These settings apply across the app.
      </p>

      <div class="settings-row">
        <label id="settingsLangLabel">Language</label>
        <div class="toggle-pill">
          <button type="button" id="settingsLangEn" class="active">English</button>
          <button type="button" id="settingsLangEs">Español</button>
        </div>
      </div>

      <div class="settings-row">
        <label id="settingsThemeLabel">Theme</label>
        <div class="toggle-pill">
          <button type="button" id="themeLightBtn" class="active">Light</button>
          <button type="button" id="themeDarkBtn">Dark</button>
        </div>
      </div>

      <div class="btn-row" style="margin-top:1rem;">
        <button id="settingsBackBtn" class="secondary">Back to home</button>
      </div>
    </section>

    <!-- SCANNER -->
    <section class="section scanner" id="scannerSection">
      <div class="scanner-inner">
        <button id="scannerBackBtn">&#8592;</button>

        <h2 id="scannerTitle">Align the bill</h2>
        <p id="scannerBody">
          Place the selected bill flat with decent light and align it inside the frame. Then tap
          <strong>Capture</strong>.
        </p>
        <p class="current-denom" id="currentDenomText">
          Currently checking: $20 (USD)
        </p>

        <div class="video-wrapper">
          <video id="video" autoplay playsinline></video>
          <canvas id="captureCanvas" style="display:none;"></canvas>
          <div class="frame-overlay" id="frameOverlay">
            <div class="frame-box"></div>
          </div>
        </div>

        <div class="status-text" id="cameraStatus">
          Opening camera…
        </div>
        <div class="btn-row capture-row">
          <button id="captureBtn" class="round-capture">Capture</button>
          <button id="retakeBtn" class="secondary" style="display:none;">Retake</button>
          <button id="beginChecksBtn" class="secondary" style="display:none;">View results</button>
        </div>
        <p class="tiny">
          If the camera does not open, make sure you’re using a modern browser over HTTPS (or localhost)
          and that camera permissions are granted.
        </p>
      </div>
    </section>

    <!-- CHECKLIST (optional manual, can be extended later) -->
    <section class="section checklist" id="checklistSection">
      <div class="step-indicator" id="stepIndicator">Step 1 of 3</div>
      <div class="step-header" id="stepTitle"></div>
      <div class="step-body" id="stepBody"></div>
      <div class="btn-row">
        <button class="answer-btn yes" data-answer="yes" id="btnYes">Yes</button>
        <button class="answer-btn maybe" data-answer="maybe" id="btnMaybe">Not sure</button>
        <button class="answer-btn no" data-answer="no" id="btnNo">No</button>
      </div>
    </section>

    <!-- RESULTS -->
    <section class="section results" id="resultsSection">
      <div class="result-tag" id="resultTag"></div>
      <p class="result-note" id="resultSummary"></p>

      <!-- AI feature breakdown -->
      <div class="results-features" id="resultsFeatures" style="display:none;">
        <div class="results-features-header">
          <div class="results-features-title" id="resultsFeaturesTitle">
            AI feature breakdown
          </div>
          <div class="results-features-sub" id="resultsFeaturesSub">
            Higher scores are closer to typical genuine behavior.
          </div>
        </div>
        <div class="results-features-list" id="resultsFeaturesList">
          <!-- rows injected by JS -->
        </div>
      </div>

      <div class="divider"></div>
      <p class="tiny" id="resultDisclaimer">
        This tool is designed for education and basic screening only. It does not provide a
        definitive authenticity determination. If anything feels off, treat the bill as
        suspicious and have it checked by your bank or appropriate authorities.
      </p>
      <div class="btn-row">
        <button id="restartBtn" class="secondary">Back to home</button>
      </div>
    </section>
  </div>

  <script>
    // ---- Config ----
    const ANALYZE_API_URL = "https://your-backend-url.com/analyze-note"; // TODO: replace
    const SCANS_STORAGE_KEY = "billcheck_scans_v1";

    // ---- state ----
    const state = { lang: "en", denom: 20, theme: "light" };

    let stream = null;
    let lastAnalysis = null;
    let isAnalyzing = false;
    let answers = [];
    let currentStepIndex = 0;
    let steps = [];
    let scans = [];
    let lastCaptureThumbBase64 = null;

    const i18n = {
      en: {
        badge: "Experimental tool",
        appTitle: "BillCheck – Quick Screen",
        disclaimer: "This is a preliminary helper only. It cannot guarantee authenticity. When in doubt, have a bank or law enforcement verify the bill.",
        howWorksTitle: "How this works",
        howWorksBody: "Choose a U.S. bill, then we’ll use your camera to capture it, highlight key areas, and walk you through a quick AI-assisted screen.",
        denomLabel: "Supported today: U.S. bills",
        intlComingSoon: "International currencies: support coming soon.",
        startScanBtn: "Start scan",
        myScansBtn: "My scans",
        settingsBtn: "Settings",
        scannerTitle: "Align the bill",
        scannerBody: "Place the selected bill flat with decent light and align it inside the frame. Then tap Capture.",
        currentDenomText: d => `Currently checking: $${d} (USD)`,
        cameraOpening: "Opening camera…",
        cameraAlign: "Align the bill in the frame and tap Capture.",
        cameraError: "Unable to access camera. Use HTTPS/localhost and check permissions.",
        cameraNotReady: "Camera not ready yet. Try again in a moment.",
        cameraCaptured: "Image captured. Analysis is running in the background.",
        captureBtn: "Capture",
        retakeBtn: "Retake",
        beginChecksBtn: "View results",
        analyzing: "Analyzing note…",
        analyzeDone: "Analysis complete. Tap View results.",
        analyzeFailed: "Unable to analyze the note.",
        stepIndicator: (i, t) => `Step ${i + 1} of ${t}`,
        steps: d => [
          {
            title: "Watermark / embedded portrait",
            body: `Hold the $${d} bill up to a bright light and look in the highlighted area. Do you see a faint portrait or watermark that matches the main portrait, or a similar security image for this denomination?`
          },
          {
            title: "Security thread or embedded strip",
            body: `Hold the $${d} bill to the light and look for a thin, embedded strip in the highlighted region. On many denominations this is a security thread that runs vertically and can be seen from both sides.`
          },
          {
            title: "Color / print behavior",
            body: `Keep the $${d} bill flat and tilt it slowly. In the highlighted corner or ink area, look for color-shifting ink, sharp printing, and clear edges. Does anything unusual stand out, like blurry or muddy printing?`
          },
        ],
        btnYes: "Yes",
        btnMaybe: "Not sure",
        btnNo: "No",
        resultLikely: "Likely Genuine (Preliminary)",
        resultSuspicious: "Suspicious – Get it checked",
        resultInconclusive: "Inconclusive – Conditions poor",
        resultLikelyText: "Most key security features appear normal based on your answers and AI analysis. This is a helpful sign, but not a guarantee. For large amounts or if you still feel unsure, have the bill verified by a bank.",
        resultSuspiciousText: "One or more key indicators appear unusual. Treat this bill as suspicious and have it checked by a bank or appropriate authorities.",
        resultInconclusiveText: "It was hard to confirm the main security features. Lighting, camera angle, or bill condition may have made checks difficult. If you have any doubts, ask a bank to verify the bill.",
        resultDisclaimer: "This tool is designed for education and basic screening only. It does not provide a definitive authenticity determination. If anything feels off, treat the bill as suspicious and have it checked by your bank or appropriate authorities.",
        restartBtn: "Back to home",
        settingsTitle: "Settings",
        settingsIntro: "Adjust language and theme. These settings apply across the app.",
        settingsLangLabel: "Language",
        settingsThemeLabel: "Theme",
        settingsBack: "Back to home",
        themeLight: "Light",
        themeDark: "Dark",
        langFullEn: "English",
        langFullEs: "Español",
        myScansTitle: "My scans",
        myScansEmpty: "No scans yet. When you run checks, your recent scans will show up here with a small thumbnail and risk summary.",
        myScansSummary: (count) =>
          count === 0
            ? "No scans yet."
            : count === 1
            ? "You have 1 saved scan."
            : `You have ${count} saved scans.`,
        clearScansLabel: "Clear all",
        backFromMyScans: "Back to home",
        resultsFeaturesTitle: "AI feature breakdown",
        resultsFeaturesSub: "Higher scores are closer to typical genuine behavior."
      },
      es: {
        badge: "Herramienta experimental",
        appTitle: "BillCheck – Revisión rápida",
        disclaimer: "Esta es solo una ayuda preliminar. No puede garantizar la autenticidad. En caso de duda, pide que el billete sea verificado por un banco o las autoridades.",
        howWorksTitle: "Cómo funciona",
        howWorksBody: "Elige un billete de EE. UU. y usaremos la cámara para capturarlo, resaltar zonas clave y guiarte por una revisión rápida asistida por IA.",
        denomLabel: "Compatibles hoy: billetes de EE. UU.",
        intlComingSoon: "Monedas internacionales: compatibilidad disponible pronto.",
        startScanBtn: "Iniciar escaneo",
        myScansBtn: "Mis escaneos",
        settingsBtn: "Configuración",
        scannerTitle: "Alinea el billete",
        scannerBody: "Coloca el billete elegido en una superficie plana, con buena luz, y alinéalo dentro del marco. Luego toca Capturar.",
        currentDenomText: d => `Comprobando: $${d} (USD)`,
        cameraOpening: "Abriendo la cámara…",
        cameraAlign: "Alinea el billete en el marco y toca Capturar.",
        cameraError: "No se pudo acceder a la cámara. Usa HTTPS/localhost y revisa los permisos.",
        cameraNotReady: "La cámara aún no está lista. Intenta de nuevo en un momento.",
        cameraCaptured: "Imagen capturada. El análisis se está ejecutando en segundo plano.",
        captureBtn: "Capturar",
        retakeBtn: "Repetir",
        beginChecksBtn: "Ver resultados",
        analyzing: "Analizando billete…",
        analyzeDone: "Análisis completado. Toca Ver resultados.",
        analyzeFailed: "No se pudo analizar el billete.",
        stepIndicator: (i, t) => `Paso ${i + 1} de ${t}`,
        steps: d => [
          {
            title: "Marca de agua / retrato",
            body: `Sostén el billete de $${d} frente a una luz fuerte y mira en la zona resaltada. ¿Ves un retrato tenue o marca de agua que coincida con el retrato principal, o una imagen de seguridad similar para este valor?`
          },
          {
            title: "Hilo de seguridad o franja",
            body: `Sostén el billete de $${d} a contraluz y busca una tira delgada incrustada en la zona resaltada. En muchos valores esto es un hilo de seguridad vertical visible desde ambos lados.`
          },
          {
            title: "Color / calidad de impresión",
            body: `Mantén el billete de $${d} plano e inclínalo lentamente. En la esquina o zona de tinta resaltada, busca tinta que cambie de color, impresión nítida y bordes claros. ¿Notas algo raro, como impresión borrosa o manchada?`
          },
        ],
        btnYes: "Sí",
        btnMaybe: "No estoy seguro",
        btnNo: "No",
        resultLikely: "Probablemente auténtico (preliminar)",
        resultSuspicious: "Sospechoso – Pide revisión",
        resultInconclusive: "Inconcluso – Condiciones deficientes",
        resultLikelyText: "Según tus respuestas y el análisis de IA, la mayoría de las características de seguridad parecen normales. Es una buena señal, pero no una garantía. Para importes grandes o si tienes dudas, haz que un banco verifique el billete.",
        resultSuspiciousText: "Una o más señales clave parecen inusuales. Trata este billete como sospechoso y haz que lo revise un banco o las autoridades.",
        resultInconclusiveText: "Ha sido difícil confirmar las principales características de seguridad. La luz, el ángulo de la cámara o el estado del billete pueden haber complicado la revisión. Si tienes dudas, pide a un banco que verifique el billete.",
        resultDisclaimer: "Esta herramienta está pensada solo para educación y una revisión básica. No ofrece una determinación definitiva de autenticidad. Si algo no te cuadra, trata el billete como sospechoso y haz que lo revise tu banco o las autoridades.",
        restartBtn: "Volver al inicio",
        settingsTitle: "Configuración",
        settingsIntro: "Ajusta el idioma y el tema. Estos ajustes afectan a toda la aplicación.",
        settingsLangLabel: "Idioma",
        settingsThemeLabel: "Tema",
        settingsBack: "Volver al inicio",
        themeLight: "Claro",
        themeDark: "Oscuro",
        langFullEn: "Inglés",
        langFullEs: "Español",
        myScansTitle: "Mis escaneos",
        myScansEmpty: "Aún no hay escaneos. Cuando hagas revisiones, verás aquí miniaturas y un resumen de riesgo.",
        myScansSummary: (count) =>
          count === 0
            ? "Aún no hay escaneos."
            : count === 1
            ? "Tienes 1 escaneo guardado."
            : `Tienes ${count} escaneos guardados.`,
        clearScansLabel: "Borrar todos",
        backFromMyScans: "Volver al inicio",
        resultsFeaturesTitle: "Desglose de funciones IA",
        resultsFeaturesSub: "Puntuaciones más altas se acercan al comportamiento típico de un billete auténtico."
      }
    };

    // ---- DOM refs ----
    const appRoot = document.querySelector(".app");
    const bodyEl = document.body;

    const homeSection = document.getElementById("homeSection");
    const settingsSection = document.getElementById("settingsSection");
    const scannerSection = document.getElementById("scannerSection");
    const checklistSection = document.getElementById("checklistSection");
    const resultsSection = document.getElementById("resultsSection");
    const myScansSection = document.getElementById("myScansSection");

    const badgeText = document.getElementById("badgeText");
    const appTitle = document.getElementById("appTitle");
    const disclaimerText = document.getElementById("disclaimerText");
    const howWorksTitle = document.getElementById("howWorksTitle");
    const howWorksBody = document.getElementById("howWorksBody");
    const denomLabel = document.getElementById("denomLabel");
    const intlComingSoon = document.getElementById("intlComingSoon");

    const startScanBtn = document.getElementById("startScanBtn");
    const openMyScansBtn = document.getElementById("openMyScansBtn");
    const openSettingsBtn = document.getElementById("openSettingsBtn");

    const settingsTitle = document.getElementById("settingsTitle");
    const settingsIntro = document.getElementById("settingsIntro");
    const settingsLangLabel = document.getElementById("settingsLangLabel");
    const settingsThemeLabel = document.getElementById("settingsThemeLabel");
    const settingsBackBtn = document.getElementById("settingsBackBtn");

    const settingsLangEn = document.getElementById("settingsLangEn");
    const settingsLangEs = document.getElementById("settingsLangEs");
    const themeLightBtn = document.getElementById("themeLightBtn");
    const themeDarkBtn = document.getElementById("themeDarkBtn");

    const scannerTitle = document.getElementById("scannerTitle");
    const scannerBody = document.getElementById("scannerBody");
    const currentDenomText = document.getElementById("currentDenomText");
    const cameraStatus = document.getElementById("cameraStatus");

    const captureBtn = document.getElementById("captureBtn");
    const retakeBtn = document.getElementById("retakeBtn");
    const beginChecksBtn = document.getElementById("beginChecksBtn");
    const scannerBackBtn = document.getElementById("scannerBackBtn");

    const stepIndicator = document.getElementById("stepIndicator");
    const stepTitle = document.getElementById("stepTitle");
    const stepBody = document.getElementById("stepBody");
    const btnYes = document.getElementById("btnYes");
    const btnMaybe = document.getElementById("btnMaybe");
    const btnNo = document.getElementById("btnNo");

    const resultTag = document.getElementById("resultTag");
    const resultSummary = document.getElementById("resultSummary");
    const resultDisclaimer = document.getElementById("resultDisclaimer");
    const restartBtn = document.getElementById("restartBtn");

    const langEn = document.getElementById("langEn");
    const langEs = document.getElementById("langEs");

    const denomRow = document.getElementById("denomRow");

    const video = document.getElementById("video");
    const captureCanvas = document.getElementById("captureCanvas");
    const frameOverlay = document.getElementById("frameOverlay");

    const answerButtons = document.querySelectorAll(".answer-btn");

    const myScansTitle = document.getElementById("myScansTitle");
    const myScansSummary = document.getElementById("myScansSummary");
    const scanList = document.getElementById("scanList");
    const backFromMyScansBtn = document.getElementById("backFromMyScansBtn");
    const clearScansBtn = document.getElementById("clearScansBtn");

    const resultsFeatures = document.getElementById("resultsFeatures");
    const resultsFeaturesTitle = document.getElementById("resultsFeaturesTitle");
    const resultsFeaturesSub = document.getElementById("resultsFeaturesSub");
    const resultsFeaturesList = document.getElementById("resultsFeaturesList");

    // ---- Section helpers ----
    function showSection(section) {
      [homeSection, settingsSection, scannerSection, checklistSection, resultsSection, myScansSection]
        .forEach(sec => sec.classList.remove("active"));
      if (section) section.classList.add("active");
    }

    // ---- Lang & theme ----
    function updateLangToggleUI() {
      if (state.lang === "en") {
        langEn.classList.add("active");
        langEs.classList.remove("active");
        settingsLangEn.classList.add("active");
        settingsLangEs.classList.remove("active");
      } else {
        langEs.classList.add("active");
        langEn.classList.remove("active");
        settingsLangEs.classList.add("active");
        settingsLangEn.classList.remove("active");
      }
    }

    function applyTheme() {
      if (state.theme === "light") {
        bodyEl.classList.remove("theme-dark");
        bodyEl.classList.add("theme-light");
        themeLightBtn.classList.add("active");
        themeDarkBtn.classList.remove("active");
      } else {
        bodyEl.classList.remove("theme-light");
        bodyEl.classList.add("theme-dark");
        themeDarkBtn.classList.add("active");
        themeLightBtn.classList.remove("active");
      }
    }

    function applyLanguage() {
      const t = i18n[state.lang];
      badgeText.textContent = t.badge;
      appTitle.textContent = t.appTitle;
      disclaimerText.innerHTML = t.disclaimer;
      howWorksTitle.textContent = t.howWorksTitle;
      howWorksBody.textContent = t.howWorksBody;
      denomLabel.textContent = t.denomLabel;
      intlComingSoon.textContent = t.intlComingSoon;
      startScanBtn.textContent = t.startScanBtn;
      openMyScansBtn.textContent = t.myScansBtn;
      openSettingsBtn.textContent = t.settingsBtn;

      scannerTitle.textContent = t.scannerTitle;
      scannerBody.textContent = t.scannerBody;
      currentDenomText.textContent = t.currentDenomText(state.denom);

      cameraStatus.textContent = t.cameraOpening;
      captureBtn.textContent = t.captureBtn;
      retakeBtn.textContent = t.retakeBtn;
      beginChecksBtn.textContent = t.beginChecksBtn;

      btnYes.textContent = t.btnYes;
      btnMaybe.textContent = t.btnMaybe;
      btnNo.textContent = t.btnNo;

      resultDisclaimer.textContent = t.resultDisclaimer;
      restartBtn.textContent = t.restartBtn;

      settingsTitle.textContent = t.settingsTitle;
      settingsIntro.textContent = t.settingsIntro;
      settingsLangLabel.textContent = t.settingsLangLabel;
      settingsThemeLabel.textContent = t.settingsThemeLabel;
      settingsBackBtn.textContent = t.settingsBack;
      settingsLangEn.textContent = t.langFullEn;
      settingsLangEs.textContent = t.langFullEs;
      themeLightBtn.textContent = t.themeLight;
      themeDarkBtn.textContent = t.themeDark;

      myScansTitle.textContent = t.myScansTitle;
      clearScansBtn.textContent = t.clearScansLabel;
      backFromMyScansBtn.textContent = t.backFromMyScans;

      resultsFeaturesTitle.textContent = t.resultsFeaturesTitle;
      resultsFeaturesSub.textContent = t.resultsFeaturesSub;

      steps = t.steps(state.denom);
      showStep(currentStepIndex);
      updateMyScansUI();
    }

    function updateDenomButtons() {
      const buttons = denomRow.querySelectorAll(".denom-btn");
      buttons.forEach(btn => {
        const val = parseInt(btn.getAttribute("data-denom"), 10);
        btn.classList.toggle("active", val === state.denom);
      });
      const t = i18n[state.lang];
      currentDenomText.textContent = t.currentDenomText(state.denom);
      steps = t.steps(state.denom);
    }

    // ---- Camera & capture ----
    async function startCamera() {
      const t = i18n[state.lang];
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        cameraStatus.textContent = t.cameraError;
        return;
      }
      cameraStatus.textContent = t.cameraOpening;

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        video.srcObject = stream;
        cameraStatus.textContent = t.cameraAlign;
      } catch (err) {
        console.error("Camera error", err);
        cameraStatus.textContent = t.cameraError;
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }

    function drawOverlays() {
      const ctx = captureCanvas.getContext("2d");
      const w = captureCanvas.width;
      const h = captureCanvas.height;

      ctx.strokeStyle = "rgba(56,189,248,0.9)";
      ctx.lineWidth = Math.max(2, w * 0.003);

      const wmX = w * 0.07;
      const wmY = h * 0.25;
      const wmW = w * 0.18;
      const wmH = h * 0.5;
      ctx.strokeRect(wmX, wmY, wmW, wmH);

      const stX = w * 0.33;
      const stY = h * 0.15;
      const stW = w * 0.03;
      const stH = h * 0.7;
      ctx.strokeRect(stX, stY, stW, stH);

      const csX = w * 0.70;
      const csY = h * 0.60;
      const csW = w * 0.22;
      const csH = h * 0.25;
      ctx.strokeRect(csX, csY, csW, csH);
    }

    function canvasToBase64JPEG(canvas, quality = 0.85) {
      const dataUrl = canvas.toDataURL("image/jpeg", quality);
      const idx = dataUrl.indexOf(",");
      return idx >= 0 ? dataUrl.slice(idx + 1) : dataUrl;
    }

    function makeThumbnailBase64() {
      const width = captureCanvas.width;
      const height = captureCanvas.height;
      if (!width || !height) return null;

      const maxW = 320;
      const scale = maxW / width;
      const thumbW = maxW;
      const thumbH = Math.round(height * scale);

      const thumbCanvas = document.createElement("canvas");
      thumbCanvas.width = thumbW;
      thumbCanvas.height = thumbH;
      const ctx = thumbCanvas.getContext("2d");
      ctx.drawImage(captureCanvas, 0, 0, thumbW, thumbH);

      return canvasToBase64JPEG(thumbCanvas, 0.8);
    }

    async function captureFrame() {
      const t = i18n[state.lang];
      const width = video.videoWidth;
      const height = video.videoHeight;

      if (!width || !height) {
        cameraStatus.textContent = t.cameraNotReady;
        console.warn("Video not ready for capture");
        return;
      }

      captureCanvas.width = width;
      captureCanvas.height = height;
      const ctx = captureCanvas.getContext("2d");
      ctx.drawImage(video, 0, 0, width, height);

      video.style.display = "none";
      captureCanvas.style.display = "block";
      frameOverlay.style.display = "none";

      drawOverlays();

      lastCaptureThumbBase64 = makeThumbnailBase64();

      cameraStatus.textContent = t.cameraCaptured;
      captureBtn.style.display = "none";
      retakeBtn.style.display = "inline-flex";
      beginChecksBtn.style.display = "inline-flex";

      if (appRoot && appRoot.classList) {
        appRoot.classList.remove("scanning-full");
      }

      // Kick off AI analysis
      await analyzeWithAI();
    }

    function resetScannerView() {
      const t = i18n[state.lang];
      video.style.display = "block";
      captureCanvas.style.display = "none";
      frameOverlay.style.display = "flex";
      captureBtn.style.display = "inline-flex";
      retakeBtn.style.display = "none";
      beginChecksBtn.style.display = "none";
      cameraStatus.textContent = t.cameraAlign;
      lastAnalysis = null;
      lastCaptureThumbBase64 = null;
    }

    // ---- AI call ----
    async function analyzeWithAI() {
      const t = i18n[state.lang];
      if (!ANALYZE_API_URL) {
        cameraStatus.textContent = t.analyzeFailed;
        return;
      }

      try {
        isAnalyzing = true;
        cameraStatus.textContent = t.analyzing;

        const image_base64 = canvasToBase64JPEG(captureCanvas, 0.9);

        const payload = {
          image_base64,
          currency: "USD",
          denomination: state.denom,
          side: "front",
          app_version: "1.0.0",
          device_info: {
            platform: "web",
            user_agent: navigator.userAgent
          }
        };

        const res = await fetch(ANALYZE_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error("API " + res.status);
        }

        lastAnalysis = await res.json();
        cameraStatus.textContent = t.analyzeDone;

        // Save scan record locally
        saveScanRecord();
      } catch (err) {
        console.error("Error calling analyze-note:", err);
        cameraStatus.textContent = t.analyzeFailed;
      } finally {
        isAnalyzing = false;
      }
    }

    // ---- Checklist / results ----
    function showStep(index) {
      const t = i18n[state.lang];
      if (!steps.length) steps = t.steps(state.denom);
      currentStepIndex = index;
      stepIndicator.textContent = t.stepIndicator(index, steps.length);
      stepTitle.textContent = steps[index].title;
      stepBody.textContent = steps[index].body;
    }

    function applyAIResultToUI() {
      if (!lastAnalysis) {
        resultsFeatures.style.display = "none";
        return;
      }

      const t = i18n[state.lang];
      const band = lastAnalysis.decision_band;
      const score = lastAnalysis.authenticity_score;

      let tagText, tagClass, summary;

      if (band === "likely_genuine") {
        tagText = t.resultLikely;
        tagClass = "ok";
        summary =
          t.resultLikelyText +
          ` (AI score: ${(score * 100).toFixed(1)}% likelihood of genuine behavior.)`;
      } else if (band === "suspicious") {
        tagText = t.resultSuspicious;
        tagClass = "bad";
        summary =
          t.resultSuspiciousText +
          ` (AI score: ${(score * 100).toFixed(1)}% – treat as high risk.)`;
      } else {
        tagText = t.resultInconclusive;
        tagClass = "warn";
        summary =
          t.resultInconclusiveText +
          ` (AI score: ${(score * 100).toFixed(1)}% – unclear due to conditions.)`;
      }

      resultTag.className = `result-tag ${tagClass}`;
      resultTag.textContent = tagText;
      resultSummary.textContent = summary;

      const feats = lastAnalysis.features;
      if (!feats) {
        resultsFeatures.style.display = "none";
        return;
      }

      const labelMap = {
        layout_consistency: state.lang === "es" ? "Diseño general" : "Layout consistency",
        watermark: state.lang === "es" ? "Marca de agua" : "Watermark",
        security_thread: state.lang === "es" ? "Hilo de seguridad" : "Security thread",
        print_texture: state.lang === "es" ? "Textura de impresión" : "Print texture",
        corner_denomination:
          state.lang === "es" ? "Valor en esquinas" : "Corner denomination",
      };

      const order = [
        "layout_consistency",
        "watermark",
        "security_thread",
        "print_texture",
        "corner_denomination",
      ];

      resultsFeaturesList.innerHTML = "";

      order.forEach((key) => {
        const f = feats[key];
        if (!f) return;

        const row = document.createElement("div");
        row.className = "feature-row";

        const label = document.createElement("div");
        label.className = "feature-label";
        label.textContent = labelMap[key] || key;

        const right = document.createElement("div");
        right.className = "feature-right";

        const scoreEl = document.createElement("div");
        scoreEl.className = "feature-score";
        scoreEl.textContent = (f.score * 100).toFixed(0) + "%";

        const pill = document.createElement("div");
        pill.className = `feature-status-pill ${f.status}`;
        pill.textContent =
          f.status === "ok"
            ? (state.lang === "es" ? "OK" : "OK")
            : f.status === "warn"
            ? (state.lang === "es" ? "Atención" : "Check")
            : state.lang === "es"
            ? "Falla"
            : "Fail";

        right.appendChild(scoreEl);
        right.appendChild(pill);

        row.appendChild(label);
        row.appendChild(right);

        resultsFeaturesList.appendChild(row);
      });

      resultsFeatures.style.display = "block";
    }

    // ---- My Scans storage ----
    function loadScansFromStorage() {
      try {
        const raw = localStorage.getItem(SCANS_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          scans = parsed;
        }
      } catch (e) {
        console.warn("Failed to load scans", e);
      }
    }

    function saveScansToStorage() {
      try {
        localStorage.setItem(SCANS_STORAGE_KEY, JSON.stringify(scans));
      } catch (e) {
        console.warn("Failed to save scans", e);
      }
    }

    function saveScanRecord() {
      if (!lastAnalysis || !lastAnalysis.decision_band) return;
      const now = new Date();
      const iso = now.toISOString();

      const record = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
        timestamp: iso,
        currency: lastAnalysis.currency || "USD",
        denomination: lastAnalysis.denomination || state.denom,
        side: lastAnalysis.side || "front",
        decision_band: lastAnalysis.decision_band,
        authenticity_score: lastAnalysis.authenticity_score,
        image_thumb_base64: lastCaptureThumbBase64 || null
      };

      scans.unshift(record);
      // Hard cap to avoid bloating storage
      if (scans.length > 100) scans = scans.slice(0, 100);

      saveScansToStorage();
      updateMyScansUI();
    }

    function formatTimestamp(ts) {
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return ts;
      return d.toLocaleString();
    }

    function updateMyScansUI() {
      const t = i18n[state.lang];
      const count = scans.length;

      if (count === 0) {
        myScansSummary.textContent =
          state.lang === "es" ? t.myScansEmpty : t.myScansEmpty;
        scanList.innerHTML = "";
        return;
      }

      myScansSummary.textContent = t.myScansSummary(count);

      scanList.innerHTML = "";
      scans.forEach((scan) => {
        const card = document.createElement("div");
        card.className = "scan-card";

        const thumb = document.createElement("div");
        thumb.className = "scan-thumb";
        if (scan.image_thumb_base64) {
          const img = document.createElement("img");
          img.src = "data:image/jpeg;base64," + scan.image_thumb_base64;
          thumb.appendChild(img);
        }

        const meta = document.createElement("div");
        meta.className = "scan-meta";

        const line1 = document.createElement("div");
        line1.className = "scan-line-primary";

        const leftText = document.createElement("span");
        leftText.textContent = `$${scan.denomination} • ${scan.currency}`;

        const tag = document.createElement("span");
        const band = scan.decision_band;
        let tagClass = "warn";
        let tagLabel = band;
        if (band === "likely_genuine") {
          tagClass = "ok";
          tagLabel = state.lang === "es" ? "Prob. auténtico" : "Likely";
        } else if (band === "suspicious") {
          tagClass = "bad";
          tagLabel = state.lang === "es" ? "Sospechoso" : "Suspicious";
        } else {
          tagClass = "warn";
          tagLabel = state.lang === "es" ? "Inconcluso" : "Inconclusive";
        }
        tag.className = "scan-tag " + tagClass;
        tag.textContent = tagLabel;

        line1.appendChild(leftText);
        line1.appendChild(tag);

        const line2 = document.createElement("div");
        line2.className = "scan-line-secondary";
        const score = scan.authenticity_score;
        const percent = typeof score === "number" ? (score * 100).toFixed(0) + "%" : "--";
        line2.textContent = `${formatTimestamp(scan.timestamp)} • AI score: ${percent}`;

        meta.appendChild(line1);
        meta.appendChild(line2);

        card.appendChild(thumb);
        card.appendChild(meta);

        scanList.appendChild(card);
      });
    }

    // ---- Events ----
    langEn.addEventListener("click", () => {
      state.lang = "en";
      steps = i18n[state.lang].steps(state.denom);
      updateLangToggleUI();
      applyLanguage();
    });

    langEs.addEventListener("click", () => {
      state.lang = "es";
      steps = i18n[state.lang].steps(state.denom);
      updateLangToggleUI();
      applyLanguage();
    });

    settingsLangEn.addEventListener("click", () => {
      state.lang = "en";
      steps = i18n[state.lang].steps(state.denom);
      updateLangToggleUI();
      applyLanguage();
    });

    settingsLangEs.addEventListener("click", () => {
      state.lang = "es";
      steps = i18n[state.lang].steps(state.denom);
      updateLangToggleUI();
      applyLanguage();
    });

    themeLightBtn.addEventListener("click", () => {
      state.theme = "light";
      applyTheme();
    });

    themeDarkBtn.addEventListener("click", () => {
      state.theme = "dark";
      applyTheme();
    });

    denomRow.addEventListener("click", e => {
      if (!e.target.classList.contains("denom-btn")) return;
      const denom = parseInt(e.target.getAttribute("data-denom"), 10);
      if (!Number.isNaN(denom)) {
        state.denom = denom;
        updateDenomButtons();
        currentStepIndex = 0;
        showStep(0);
      }
    });

    openSettingsBtn.addEventListener("click", () => {
      showSection(settingsSection);
    });

    settingsBackBtn.addEventListener("click", () => {
      showSection(homeSection);
    });

    openMyScansBtn.addEventListener("click", () => {
      updateMyScansUI();
      showSection(myScansSection);
    });

    backFromMyScansBtn.addEventListener("click", () => {
      showSection(homeSection);
    });

    clearScansBtn.addEventListener("click", () => {
      if (!confirm("Clear all saved scans on this device?")) return;
      scans = [];
      saveScansToStorage();
      updateMyScansUI();
    });

    startScanBtn.addEventListener("click", () => {
      answers = [];
      currentStepIndex = 0;
      updateDenomButtons();
      showStep(0);
      showSection(scannerSection);
      resetScannerView();
      applyLanguage();
      appRoot.classList.add("scanning-full");
      startCamera();
    });

    scannerBackBtn.addEventListener("click", () => {
      stopCamera();
      appRoot.classList.remove("scanning-full");
      showSection(homeSection);
    });

    captureBtn.addEventListener("click", captureFrame);

    retakeBtn.addEventListener("click", () => {
      resetScannerView();
      applyLanguage();
      appRoot.classList.add("scanning-full");
      startCamera();
    });

    beginChecksBtn.addEventListener("click", () => {
      stopCamera();
      applyAIResultToUI();
      showSection(resultsSection);
    });

    answerButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const answer = btn.getAttribute("data-answer");
        answers[currentStepIndex] = answer;

        if (currentStepIndex < steps.length - 1) {
          showStep(currentStepIndex + 1);
        } else {
          applyAIResultToUI();
          showSection(resultsSection);
        }
      });
    });

    restartBtn.addEventListener("click", () => {
      stopCamera();
      appRoot.classList.remove("scanning-full");
      showSection(homeSection);
    });

    window.addEventListener("beforeunload", stopCamera);

    // ---- Init ----
    loadScansFromStorage();
    updateMyScansUI();
    updateLangToggleUI();
    applyTheme();
    updateDenomButtons();
    steps = i18n[state.lang].steps(state.denom);
    showStep(0);
    applyLanguage();
    showSection(homeSection);
  </script>
</body>
</html>
